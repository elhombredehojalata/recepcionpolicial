
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acta de Recepci√≥n telef√≥nica- PROYECTO OMAR</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.5/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617; 
            --card: #1e293b; 
            --text: #f8fafc; 
            --primary: #60a5fa;
            --success: #10b981; 
            --border: #334155; 
            --label: #94a3b8; 
            --accent: #1e293b;
            --danger: #ef4444; 
            --excel: #16a34a; 
            --word: #2563eb;
            --gsheets: #0f9d58;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 900px; background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: 20px 0; border: 1px solid var(--border); }
        .header { text-align: center; margin-bottom: 35px; }
        h1 { font-size: 1.5rem; color: var(--primary); margin: 0; font-weight: 800; text-transform: uppercase; }
        .subtitle { font-size: 0.75rem; color: var(--danger); font-weight: 800; margin-top: 10px; padding: 8px 15px; border: 1px solid var(--danger); border-radius: 6px; display: inline-block; text-transform: uppercase; background: rgba(239, 68, 68, 0.1); }
        .section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 30px 0 15px 0; border-bottom: 2px solid var(--border); padding-bottom: 5px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .field-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        label { font-size: 0.7rem; font-weight: 700; color: var(--label); margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: #0f172a; color: white; font-size: 0.95rem; }
        .detenido-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); position: relative; }
        .btn-add { background: transparent; color: var(--primary); border: 2px dashed var(--primary); padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: 800; margin-bottom: 20px; }
        .download-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px; }
        .btn-dl { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 18px; border-radius: 12px; border: none; cursor: pointer; color: white; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; }
        .btn-acta { background: var(--word); }
        .btn-tabla { background: #4f46e5; }
        .btn-excel { background: var(--excel); }
        .btn-gsheets { background: var(--gsheets); }
        #loader-overlay { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .loader-box { width: 320px; text-align: center; }
        .loader-text { margin-bottom: 20px; font-weight: 700; color: var(--primary); min-height: 1.2em; text-transform: uppercase; letter-spacing: 1px; }
        .progress-container { width: 100%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 15px var(--primary); transition: width 0.4s ease; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; max-width: 650px; padding: 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .btn-remove { position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; z-index: 10; }
        .option-card { background: #0f172a; border: 2px solid var(--border); padding: 15px; border-radius: 15px; margin: 20px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .option-card.active { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        #link-verificacion { color: var(--primary); text-decoration: underline; font-weight: bold; cursor: pointer; display: block; margin-top: 15px; font-size: 0.8rem; }

        /* ‚îÄ‚îÄ AUTOCOMPLETE DELITOS ‚îÄ‚îÄ */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f172a;
            border: 2px solid var(--primary);
            border-radius: 10px;
            z-index: 1000;
            max-height: 220px;
            overflow-y: auto;
            margin-top: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .autocomplete-list div {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.88rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .autocomplete-list div:last-child { border-bottom: none; }
        .autocomplete-list div:hover, .autocomplete-list div.active-item { background: rgba(96,165,250,0.15); color: var(--primary); }

        /* ‚îÄ‚îÄ MODAL CONFIRMACI√ìN SHEETS ‚îÄ‚îÄ */
        #modalConfirmarSheets .modal-content { max-width: 580px; }
        .resumen-sheet { background: #0f172a; border-radius: 12px; padding: 18px; margin: 18px 0; border: 1px solid var(--border); }
        .resumen-sheet .fila { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .resumen-sheet .fila:last-child { border-bottom: none; }
        .resumen-sheet .fila .clave { color: var(--label); font-weight: 700; text-transform: uppercase; font-size: 0.72rem; }
        .resumen-sheet .fila .valor { color: var(--text); font-weight: 600; text-align: right; max-width: 60%; }
        .resumen-sheet .subtitulo-det { color: var(--primary); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin: 12px 0 6px; }
        .tag-det { display: inline-block; background: rgba(96,165,250,0.12); border: 1px solid var(--primary); color: var(--primary); border-radius: 6px; padding: 3px 10px; font-size: 0.78rem; margin: 3px 3px 3px 0; font-weight: 700; }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="loader-box">
        <div class="loader-text" id="loader-status">INICIANDO...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <a id="link-verificacion" style="display:none;" href="https://docs.google.com/spreadsheets/d/1fIMj_PktWRt_OPkVGwbePXRLiUnKnjDV7CA0MfskQe8/edit?gid=0#gid=0" target="_blank">VERIFICAR EN HOJA DE C√ÅLCULO üîó</a>
    </div>
</div>

<div class="app-container">
    <div class="header">
        <h1>‚öñÔ∏è Acta de recepci√≥n telef√≥nica - V1.1.4 Angel Oliden</h1>
        <div class="subtitle">USO INTERNO - PROHIBIDA SU DIFUSI√ìN</div>
    </div>
    
    <form id="docForm">
        <div class="section-title">üèõÔ∏è 1. Datos del Acta y Fiscal√≠a</div>
        <div class="grid-3">
            <div class="field-group"><label>Hora Llamada</label><input type="time" id="hora_acta"></div>
            <div class="field-group"><label>Fecha</label><input type="text" id="fecha_acta"></div>
            <div class="field-group">
                <label>N¬∞ Fiscal√≠a</label>
                <select id="num_fiscalia">
                    <option value="PRIMERA">PRIMERA</option>
                    <option value="SEGUNDA" selected>SEGUNDA</option>
                    <option value="TERCERA">TERCERA</option>
                </select>
            </div>
        </div>

       <div class="field-group">
    <label>Fiscal Responsable</label>
    <select id="fiscal_responsable" onchange="verificarFiscal()">
        <option value="DRA. MAR√çA ANG√âLICA LAZO ALBURQUEQUE" style="font-weight: bold;">DRA. MAR√çA ANG√âLICA LAZO ALBURQUEQUE</option>
        <option value="DRA. SARA RUTH YARLEQU√â ADRIANZ√âN" style="font-weight: bold;" selected>DRA. SARA RUTH YARLEQU√â ADRIANZ√âN</option>
        <option value="DRA. MARISOL RODR√çGUEZ CHERO" style="font-weight: bold;">DRA. MARISOL RODR√çGUEZ CHERO</option>
        <option value="DRA. KAREN YESSENIA GUERRERO PE√ëA">DRA. KAREN YESSENIA GUERRERO PE√ëA</option>
        <option value="DRA. MARIANELLA WONG CARDOZA">DRA. MARIANELLA WONG CARDOZA</option>
        <option value="DRA. YERALDINE PRISCILA POZO CORDOVA">DRA. YERALDINE PRISCILA POZO CORDOVA</option>
        <option value="DRA. EVELYN YASMY RODRIGUEZ SEMINARIO">DRA. EVELYN YASMY RODRIGUEZ SEMINARIO</option>
        <option value="DRA. MARYURI VALERY PEREZ YAMUCA">DRA. MARYURI VALERY PEREZ YAMUCA</option>
        <option value="DRA. LEIDY MARIA AQUINO PACHERREZ">DRA. LEIDY MARIA AQUINO PACHERREZ</option>
        <option value="DRA. CLAUDIA VIVIANA JARAMILLO RAMOS">DRA. CLAUDIA VIVIANA JARAMILLO RAMOS</option>
        <option value="DR. CARLOS ALONSO OLIVA SALAZAR">DR. CARLOS ALONSO OLIVA SALAZAR</option>
        <option value="DR. EDMUND ANTENOR ALIAGA RIVERA">DR. EDMUND ANTENOR ALIAGA RIVERA</option>
        <option value="DRA. CARMEN GUILIANA MURGUIA SUAREZ">DRA. CARMEN GUILIANA MURGUIA SUAREZ</option>
        <option value="DR. JAIR ALEJANDRO CASTILLO GUERRERO">DR. JAIR ALEJANDRO CASTILLO GUERRERO</option>
        <option value="OTROS">‚ûï OTRO FISCAL (ESPECIFICAR)...</option>
    </select>
    <input type="text" id="fiscal_otros" style="display:none; margin-top:10px;" placeholder="Escriba el nombre del Fiscal...">
</div>

        <div class="section-title">üëÆ 2. Datos de la Comunicaci√≥n Policial</div>
        <div class="grid-3">
            <div class="field-group"><label>Celular PNP</label><input type="text" id="celular_pnp"></div>
            <div class="field-group"><label>Nombre PNP</label><input type="text" id="nombre_pnp"></div>
            <div class="field-group"><label>DNI PNP</label><input type="text" id="dni_pnp" maxlength="8"></div>
        </div>
        <div class="field-group">
            <label>Unidad Policial (Comisar√≠a o Departamento)</label>
            <select id="unidad_pnp" onchange="verificarUnidad()">
                <option value="CEOPOL I MACREPOL PIURA">CEOPOL I MACREPOL PIURA</option>
                <option value="COMISAR√çA PNP">COMISAR√çA PNP</option>
                <option value="COMISAR√çA PNP DE EL INDIO">COMISAR√çA PNP DE EL INDIO</option>
                <option value="COMISAR√çA PNP DE TACAL√Å">COMISAR√çA PNP DE TACAL√Å</option>
                <option value="COMISAR√çA PNP DE VEINTIS√âIS DE OCTUBRE">COMISAR√çA PNP DE VEINTIS√âIS DE OCTUBRE</option>
                <option value="COMISARIA LA ARENA">COMISARIA LA ARENA</option>
                <option value="COMISARIA SULLANA">COMISARIA SULLANA</option>
                <option value="CPNP 26 DE OCTUBRE">CPNP 26 DE OCTUBRE</option>
                <option value="CPNP CASTILLA">CPNP CASTILLA</option>
                <option value="CPNP CATACAOS">CPNP CATACAOS</option>
                <option value="CPNP CHALACO">CPNP CHALACO</option>
                <option value="CPNP CRUZETA">CPNP CRUZETA</option>
                <option value="CPNP EL ALTO">CPNP EL ALTO</option>
                <option value="CPNP EL INDIO">CPNP EL INDIO</option>
                <option value="CPNP LA HUACA">CPNP LA HUACA</option>
                <option value="CPNP LA UNI√ìN">CPNP LA UNI√ìN</option>
                <option value="CPNP LOS ALGARROBOS">CPNP LOS ALGARROBOS</option>
                <option value="CPNP MANCORA">CPNP MANCORA</option>
                <option value="CPNP PAITA">CPNP PAITA</option>
                <option value="CPNP PIURA" selected>CPNP PIURA</option>
                <option value="CPNP PUEBLO NUEVO DE COLAN">CPNP PUEBLO NUEVO DE COLAN</option>
                <option value="CPNP SAN MARTIN">CPNP SAN MARTIN</option>
                <option value="CPNP TACAL√Å">CPNP TACAL√Å</option>
                <option value="CPNP TALANDRACAS">CPNP TALANDRACAS</option>
                <option value="CPNP TALARA">CPNP TALARA</option>
                <option value="CPNP TAMARINDO">CPNP TAMARINDO</option>
                <option value="CPNP TAMBOGRANDE">CPNP TAMBOGRANDE</option>
                <option value="DEP. ROBO DE VEH√çCULOS PNP">DEP. ROBO DE VEH√çCULOS PNP</option>
                <option value="DEPROVE PIURA">DEPROVE PIURA</option>
                <option value="DIRECCI√ìN DESCONCENTRADA INDECI">DIRECCI√ìN DESCONCENTRADA INDECI</option>
                <option value="EMERGENCIA PNP">EMERGENCIA PNP</option>
                <option value="ESCUADRON EMERGENCIA 105 SULLANA">ESCUADRON EMERGENCIA 105 SULLANA</option>
                <option value="ESCUADRON VERDE SULLANA">ESCUADRON VERDE SULLANA</option>
                <option value="INVESTIGACI√ìN CRIMINAL PNP">INVESTIGACI√ìN CRIMINAL PNP</option>
                <option value="RADIO PATRULLA PNP">RADIO PATRULLA PNP</option>
                <option value="REGPOL PIURA SEC.">REGPOL PIURA SEC.</option>
                <option value="SERENAZGO">SERENAZGO</option>
                <option value="SERENAZGO (SECOM)">SERENAZGO (SECOM)</option>
                <option value="OTROS">‚ûï OTROS (ESPECIFICAR)...</option>
            </select>
            <input type="text" id="unidad_pnp_otros" style="display:none; margin-top:10px;" placeholder="Escriba el nombre de la Unidad...">
        </div>

        <div class="section-title">üë§ 3. Datos de los Detenidos</div>
        <div id="contenedor_detenidos">
            <div class="detenido-card">
                <div class="grid-3">
                    <div class="field-group"><label>Nombre Completo</label><input type="text" class="detenido_nombre"></div>
                    <div class="field-group"><label>DNI / DOC</label><input type="text" class="detenido_dni"></div>
                    <div class="field-group"><label>Edad</label><input type="number" class="detenido_edad"></div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="agregarDetenido()">‚ûï AGREGAR OTRO DETENIDO</button>

        <div class="section-title">üë§ 4. Datos de los Agraviados</div>
        <div id="contenedor_agraviados">
            <div class="detenido-card">
                <div class="grid-3">
                    <div class="field-group"><label>Nombre Agraviado</label><input type="text" class="agraviado_nombre"></div>
                    <div class="field-group"><label>DNI / DOC</label><input type="text" class="agraviado_dni"></div>
                    <div class="field-group"><label>Edad</label><input type="number" class="agraviado_edad"></div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="agregarAgraviado()">‚ûï AGREGAR OTRO AGRAVIADO</button>

        <div class="section-title">üö® 5. Detalles de la Intervenci√≥n</div>
        <div class="grid-3">
            <!-- DELITO CON AUTOCOMPLETADO -->
            <div class="field-group">
                <label>Delito</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="delito" autocomplete="off" oninput="filtrarDelitos()" onblur="ocultarSugerencias()" onkeydown="navSugerencias(event)" placeholder="Escriba para buscar...">
                    <div class="autocomplete-list" id="lista_delitos" style="display:none;"></div>
                </div>
            </div>
            <div class="field-group"><label>Hora Int.</label><input type="time" id="hora_intervencion"></div>
            <div class="field-group"><label>Lugar de Intervenci√≥n</label><input type="text" id="lugar_intervencion"></div>
        </div>

        <input type="checkbox" id="check_arresto" hidden onchange="toggleArrestoVisual()">
        <label for="check_arresto" class="option-card" id="arresto_card">
            <div><span style="font-weight:800; display:block">ü§ù ¬øArresto Ciudadano?</span><small style="color:var(--label)">Marcar si inicialmente intervino un civil</small></div>
            <div style="width:20px; height:20px; border:2px solid var(--border); border-radius:4px" id="check_box_visual"></div>
        </label>

        <div id="campos_arresto" style="display:none; background:rgba(0,0,0,0.2); padding:20px; border-radius:15px; border:1px solid var(--border); margin-bottom:20px;">
            <div class="grid-3">
                <div class="field-group"><label>Nombre Ciudadano</label><input type="text" id="nombre_ciudadano"></div>
                <div class="field-group"><label>DNI Ciudadano</label><input type="text" id="dni_ciudadano"></div>
                <div class="field-group">
                    <label>Supuesto Flagrancia</label>
                    <select id="tipo_flagrancia">
                        <option value="PROPIAMENTE DICHA">PROPIAMENTE DICHA</option>
                        <option value="CUASI FLAGRANCIA">CUASI FLAGRANCIA</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section-title">üèÅ 6. Cierre</div>
        <div class="field-group"><label>Hora de Cierre del Acta</label><input type="time" id="hora_cierre"></div>

        <!-- ‚îÄ‚îÄ BOTONES REORGANIZADOS ‚îÄ‚îÄ -->
        <div class="download-grid">
            <button type="button" class="btn-dl btn-acta"   onclick="abrirResumen('acta')">üìÑ DESCARGAR ACTA WORD</button>
            <button type="button" class="btn-dl btn-tabla"  onclick="abrirResumen('tabla')">üìã DESCARGAR TABLA RESUMEN</button>
            <button type="button" class="btn-dl btn-gsheets" onclick="abrirConfirmacionSheets()">‚òÅÔ∏è SUBIR DATOS AL SERVIDOR</button>
            <button type="button" class="btn-dl btn-excel"  onclick="abrirResumen('excel')">üìä DESCARGAR EXCEL LOCAL</button>
        </div>
    </form>
</div>

<!-- Modal edici√≥n antes de descargar Word/Excel -->
<div id="modalResumen" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary); margin-top:0; font-weight:800">EDITAR ANTES DE GENERAR</h2>
        <div class="edit-grid" id="edit-fields-container"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:25px;">
            <button class="btn-add" style="border-style:solid; border-color:var(--border); color:var(--text)" onclick="cerrarResumen()">CANCELAR</button>
            <button class="btn-dl" style="background:var(--success)" id="btnFinalizarDescarga">CONFIRMAR Y DESCARGAR</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ NUEVO MODAL CONFIRMACI√ìN SHEETS ‚îÄ‚îÄ -->
<div id="modalConfirmarSheets" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary); margin-top:0; font-weight:800; font-size:1.1rem;">‚òÅÔ∏è CONFIRMAR ENV√çO AL SERVIDOR</h2>
        <p style="color:var(--label); font-size:0.82rem; margin:0 0 5px;">Revisa el resumen antes de subir. Una vez enviado, los datos quedar√°n registrados en el sistema.</p>

        <div class="resumen-sheet" id="resumen-sheets-body">
            <!-- generado por JS -->
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
            <button class="btn-add" style="border-style:solid; border-color:var(--border); color:var(--text)" onclick="cerrarModalSheets()">‚úï CANCELAR</button>
            <button class="btn-dl btn-gsheets" onclick="confirmarEnvioSheets()">‚úÖ S√ç, SUBIR AHORA</button>
        </div>
    </div>
</div>

<script>
    let currentTarget = '';

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       LISTA COMPLETA DE DELITOS
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const DELITOS = [
        "ROBO SIMPLE","ROBO AGRAVADO","HURTO SIMPLE","HURTO AGRAVADO","RECEPTACI√ìN",
        "EXTORSI√ìN","SECUESTRO","LESIONES LEVES","LESIONES GRAVES","LESIONES GRAV√çSIMAS",
        "HOMICIDIO SIMPLE","HOMICIDIO CALIFICADO","PARRICIDIO","FEMINICIDIO","HOMICIDIO CULPOSO",
        "ABANDONO DE PERSONA EN PELIGRO","VIOLENCIA F√çSICA","VIOLENCIA PSICOL√ìGICA","VIOLENCIA FAMILIAR",
        "VIOLACI√ìN SEXUAL DE MENOR","VIOLACI√ìN SEXUAL","ACTOS CONTRA EL PUDOR","TOCAMIENTOS INDEBIDOS",
        "EXPLOTACI√ìN SEXUAL","PORNOGRAF√çA INFANTIL","PROXENETISMO","CLIENTE DE PROSTITUCI√ìN INFANTIL",
        "TRATA DE PERSONAS","ACOSO SEXUAL","CHANTAJE SEXUAL","ABUSO DE AUTORIDAD",
        "OMISI√ìN DE ACTOS FUNCIONALES","COHECHO PASIVO PROPIO","COHECHO PASIVO IMPROPIO","COHECHO ACTIVO",
        "COLUSI√ìN SIMPLE","COLUSI√ìN AGRAVADA","PECULADO","PECULADO DOLOSO","PECULADO CULPOSO",
        "MALVERSACI√ìN","CONCUSI√ìN","NEGOCIACI√ìN INCOMPATIBLE",
        "FRAUDE EN LA ADMINISTRACI√ìN DE PERSONAS JUR√çDICAS","TR√ÅFICO DE INFLUENCIAS",
        "ENRIQUECIMIENTO IL√çCITO","FALSIFICACI√ìN DE DOCUMENTOS","FALSIFICACI√ìN DE DOCUMENTOS PRIVADOS",
        "FALSA DECLARACI√ìN EN PROCEDIMIENTO ADMINISTRATIVO","FALSIFICACI√ìN DE SELLOS Y TIMBRES",
        "FALSIFICACI√ìN DE MONEDA","FALSIFICACI√ìN DE BILLETES","FALSIFICACI√ìN DE TARJETAS DE CR√âDITO",
        "FALSIFICACI√ìN DE NUMERARIO","USO DE DOCUMENTO FALSO","FALSEDAD IDEOL√ìGICA","FALSEDAD MATERIAL",
        "FALSEDAD GEN√âRICA","FRAUDE PROCESAL","ESTELIONATO","LAVADO DE ACTIVOS",
        "FINANCIAMIENTO DEL TERRORISMO","ASOCIACI√ìN IL√çCITA","ORGANIZACI√ìN CRIMINAL","USURPACI√ìN",
        "USURPACI√ìN AGRAVADA","ESTAFA","ESTAFA AGRAVADA","APROPIACI√ìN IL√çCITA","DEFRAUDACI√ìN TRIBUTARIA",
        "CONTRABANDO","TR√ÅFICO IL√çCITO DE DROGAS","MICROCOMERCIALIZACI√ìN DE DROGAS",
        "POSESI√ìN DE DROGAS CON FINES DE TR√ÅFICO","PROMOCI√ìN AL CONSUMO DE DROGAS",
        "TENENCIA ILEGAL DE ARMAS","PORTACI√ìN ILEGAL DE ARMAS","FABRICACI√ìN ILEGAL DE ARMAS",
        "TR√ÅFICO IL√çCITO DE ARMAS","CONDUCCI√ìN EN ESTADO DE EBRIEDAD",
        "CONDUCCI√ìN EN ESTADO DE DROGADICCI√ìN","OMISI√ìN A LA ASISTENCIA FAMILIAR","ABANDONO DE NI√ëO",
        "EXPOSICI√ìN A PELIGRO","RESISTENCIA A LA AUTORIDAD","VIOLENCIA CONTRA LA AUTORIDAD",
        "DESOBEDIENCIA A LA AUTORIDAD","ATENTADO CONTRA LA AUTORIDAD","ENCUBRIMIENTO PERSONAL",
        "ENCUBRIMIENTO REAL","DENUNCIA CALUMNIOSA","AUTOENCUBRIMIENTO","MOT√çN","DISTURBIOS",
        "ATENTADO CONTRA LA SEGURIDAD P√öBLICA","PELIGRO COM√öN","INCENDIO","EXPLOSIONES","ESTRAGOS",
        "CONTAMINACI√ìN AMBIENTAL","TR√ÅFICO IL√çCITO DE RESIDUOS PELIGROSOS","MINER√çA ILEGAL",
        "TALA ILEGAL","DEPREDACI√ìN DE FAUNA SILVESTRE","DEPREDACI√ìN DE FLORA","DELITOS CONTRA BOSQUES",
        "DELITOS CONTRA LOS RECURSOS NATURALES","PESCA ILEGAL","DELITOS INFORM√ÅTICOS",
        "FRAUDE INFORM√ÅTICO","ACCESO IL√çCITO A SISTEMAS INFORM√ÅTICOS","INTERCEPTACI√ìN DE DATOS",
        "INTERCEPTACI√ìN DE COMUNICACIONES","VIOLACI√ìN DE CORRESPONDENCIA",
        "VIOLACI√ìN DE SECRETO PROFESIONAL","VIOLACI√ìN DE DATOS PERSONALES","OBSTRUCCI√ìN A LA JUSTICIA",
        "OMISI√ìN DE DENUNCIA","PATROCINIO ILEGAL","LITIGACI√ìN MALICIOSA","ABANDONO DE FUNCIONES",
        "SUPLANTACI√ìN DE IDENTIDAD","ABUSO DE DOCUMENTOS DE IDENTIDAD",
        "FALSEDAD EN INFORMACI√ìN DE REGISTROS","BIGAMIA","POLIGAMIA",
        "OMISI√ìN DE PRESTACI√ìN DE ALIMENTOS","ALTERACI√ìN DE LINDEROS","PERTURBACI√ìN DE POSESI√ìN",
        "COACCI√ìN","AMENAZAS","CHANTAJE","CALUMNIA","DIFAMACI√ìN","INJURIA",
        "PROPAGACI√ìN DE ENFERMEDADES PELIGROSAS","CONTAMINACI√ìN DE AGUA","PROPAGACI√ìN DE EPIDEMIAS",
        "COMERCIALIZACI√ìN DE PRODUCTOS NOCIVOS","ADULTERACI√ìN DE ALIMENTOS",
        "TR√ÅFICO IL√çCITO DE BIENES CULTURALES","DA√ëOS SIMPLES","DA√ëOS AGRAVADOS",
        "VIOLACI√ìN DE MEDIDAS SANITARIAS","ALTERACI√ìN DE EVIDENCIAS","SUSTRACCI√ìN DE MENORES",
        "VIOLACI√ìN A LA INTIMIDAD","OMISI√ìN DE SOCORRO",
        "ATENTADO CONTRA LA INTEGRIDAD DE INFRAESTRUCTURA","ACTOS TERRORISTAS",
        "COLABORACI√ìN CON EL TERRORISMO","APOLOG√çA DEL TERRORISMO","PELIGRO POR MEDIOS DE TRANSPORTE",
        "SABOTAJE","OBSTACULIZACI√ìN DE SERVICIOS P√öBLICOS","ALTERACI√ìN DEL ORDEN P√öBLICO",
        "PERTURBACI√ìN DE SERVICIOS ESENCIALES","DESACATO","QUEBRANTAMIENTO DE CONDENA",
        "QUEBRANTAMIENTO DE MEDIDAS DE PROTECCI√ìN","QUEBRANTAMIENTO DE R√âGIMEN DE VISITAS",
        "INCUMPLIMIENTO DE MANDATO JUDICIAL","INCUMPLIMIENTO DE MEDIDAS DE SEGURIDAD",
        "OMISI√ìN DE ACATAR DISPOSICI√ìN LEGAL"
    ];

    let activeSugerencia = -1;

    function filtrarDelitos() {
        const input = document.getElementById('delito');
        const lista = document.getElementById('lista_delitos');
        const query = input.value.trim().toUpperCase();
        activeSugerencia = -1;

        if (!query) { lista.style.display = 'none'; return; }

        const coincidencias = DELITOS.filter(d => d.includes(query));
        if (coincidencias.length === 0) { lista.style.display = 'none'; return; }

        lista.innerHTML = coincidencias.slice(0, 12).map((d, i) =>
            `<div onmousedown="seleccionarDelito('${d}')" data-idx="${i}">${d}</div>`
        ).join('');
        lista.style.display = 'block';
    }

    function seleccionarDelito(valor) {
        document.getElementById('delito').value = valor;
        document.getElementById('lista_delitos').style.display = 'none';
    }

    function ocultarSugerencias() {
        setTimeout(() => { document.getElementById('lista_delitos').style.display = 'none'; }, 150);
    }

    function navSugerencias(e) {
        const lista = document.getElementById('lista_delitos');
        const items = lista.querySelectorAll('div');
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeSugerencia = Math.min(activeSugerencia + 1, items.length - 1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeSugerencia = Math.max(activeSugerencia - 1, 0);
        } else if (e.key === 'Enter' && activeSugerencia >= 0) {
            e.preventDefault();
            seleccionarDelito(items[activeSugerencia].textContent);
            return;
        } else if (e.key === 'Escape') {
            lista.style.display = 'none'; return;
        }
        items.forEach((it, i) => it.classList.toggle('active-item', i === activeSugerencia));
        if (activeSugerencia >= 0) items[activeSugerencia].scrollIntoView({ block: 'nearest' });
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       MODAL CONFIRMACI√ìN SHEETS
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function abrirConfirmacionSheets() {
        const data = obtenerDataFinal();
        const body = document.getElementById('resumen-sheets-body');

        const filas = [
            ["Fiscal√≠a", data.NUMERO_FISCALIA],
            ["Fiscal", data.FISCAL_RESPONSABLE],
            ["Fecha", data.FECHA],
            ["Hora intervenci√≥n", data.HORA_INTERVENCION],
            ["Delito", data.DELITO],
            ["Lugar", data.LUGAR_INTERVENCION],
            ["Unidad PNP", data.UNIDAD_PNP],
            ["Efectivo PNP", data.NOMBRE_PNP + (data.DNI_PNP ? ` (${data.DNI_PNP})` : "")],
            ["Arresto ciudadano", data.es_arresto_ciudadano ? "S√ç" : "NO"],
            ["Hora cierre", data.HORA_CIERRE],
        ];

        let html = filas.map(([k, v]) =>
            `<div class="fila"><span class="clave">${k}</span><span class="valor">${v || '‚Äî'}</span></div>`
        ).join('');

        // Detenidos
        if (data.lista_detenidos.length > 0) {
            html += `<div class="subtitulo-det">üë§ Detenidos (${data.lista_detenidos.length})</div>`;
            html += data.lista_detenidos.map(d =>
                `<span class="tag-det">${d.nombre} ¬∑ ${d.dni} ¬∑ ${d.edad} a√±os</span>`
            ).join('');
        }

        // Agraviados
        if (data.lista_agraviados.length > 0) {
            html += `<div class="subtitulo-det" style="color:#f59e0b; margin-top:10px;">üßë‚Äç‚öñÔ∏è Agraviados (${data.lista_agraviados.length})</div>`;
            html += data.lista_agraviados.map(a =>
                `<span class="tag-det" style="border-color:#f59e0b; color:#f59e0b; background:rgba(245,158,11,0.1)">${a.nombre_agraviado} ¬∑ ${a.dni_agraviado} ¬∑ ${a.edad_agraviado} a√±os</span>`
            ).join('');
        }

        body.innerHTML = html;
        document.getElementById('modalConfirmarSheets').style.display = 'flex';
    }

    function cerrarModalSheets() {
        document.getElementById('modalConfirmarSheets').style.display = 'none';
    }

    async function confirmarEnvioSheets() {
        cerrarModalSheets();
        await enviarAGoogleSheets();
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       RESTO DE FUNCIONES (sin cambios)
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    window.onload = function() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const f = new Date();
        document.getElementById('fecha_acta').value = `${f.getDate()} de ${meses[f.getMonth()]} del ${f.getFullYear()}`;
    };

    function verificarUnidad() {
        const sel = document.getElementById('unidad_pnp').value;
        document.getElementById('unidad_pnp_otros').style.display = (sel === "OTROS") ? "block" : "none";
    }

    function verificarFiscal() {
        const sel = document.getElementById('fiscal_responsable').value;
        document.getElementById('fiscal_otros').style.display = (sel === "OTROS") ? "block" : "none";
    }

    function agregarDetenido() {
        const id = Date.now();
        const div = document.createElement('div');
        div.className = 'detenido-card';
        div.id = `bloque_${id}`;
        div.innerHTML = `<button type="button" class="btn-remove" onclick="document.getElementById('bloque_${id}').remove()">‚úï</button><div class="grid-3"><div class="field-group"><label>Nombre Completo</label><input type="text" class="detenido_nombre"></div><div class="field-group"><label>DNI / DOC</label><input type="text" class="detenido_dni"></div><div class="field-group"><label>Edad</label><input type="number" class="detenido_edad"></div></div>`;
        document.getElementById('contenedor_detenidos').appendChild(div);
    }

    function agregarAgraviado() {
        const id = Date.now();
        const div = document.createElement('div');
        div.className = 'detenido-card';
        div.id = `agrav_${id}`;
        div.innerHTML = `<button type="button" class="btn-remove" onclick="document.getElementById('agrav_${id}').remove()">‚úï</button><div class="grid-3"><div class="field-group"><label>Nombre Agraviado</label><input type="text" class="agraviado_nombre"></div><div class="field-group"><label>DNI / DOC</label><input type="text" class="agraviado_dni"></div><div class="field-group"><label>Edad</label><input type="number" class="agraviado_edad"></div></div>`;
        document.getElementById('contenedor_agraviados').appendChild(div);
    }

    function toggleArrestoVisual() {
        const check = document.getElementById('check_arresto').checked;
        document.getElementById('arresto_card').classList.toggle('active', check);
        document.getElementById('check_box_visual').style.background = check ? 'var(--success)' : 'transparent';
        document.getElementById('campos_arresto').style.display = check ? 'block' : 'none';
    }

    function abrirResumen(tipo) {
        currentTarget = tipo;
        const container = document.getElementById('edit-fields-container');
        const fiscalVal = document.getElementById('fiscal_responsable').value === "OTROS" ? document.getElementById('fiscal_otros').value : document.getElementById('fiscal_responsable').value;
        
        container.innerHTML = `
            <div class="field-group"><label>Fiscal√≠a</label><input type="text" id="edit_num_fiscalia" value="${document.getElementById('num_fiscalia').value}"></div>
            <div class="field-group"><label>Fiscal Resp.</label><input type="text" id="edit_fiscal_responsable" value="${fiscalVal.toUpperCase()}"></div>
            <div class="field-group"><label>Delito</label><input type="text" id="edit_delito" value="${document.getElementById('delito').value.toUpperCase()}"></div>
            <div class="field-group"><label>Lugar</label><input type="text" id="edit_lugar_intervencion" value="${document.getElementById('lugar_intervencion').value.toUpperCase()}"></div>
        `;
        document.getElementById('modalResumen').style.display = 'flex';
        document.getElementById('btnFinalizarDescarga').onclick = ejecutarConAnimacion;
    }

    function cerrarResumen() { document.getElementById('modalResumen').style.display = 'none'; }

    async function ejecutarConAnimacion() {
        cerrarResumen();
        const overlay = document.getElementById('loader-overlay');
        const status = document.getElementById('loader-status');
        const bar = document.getElementById('progress-bar');
        const link = document.getElementById('link-verificacion');
        link.style.display = 'none';
        overlay.style.display = 'flex';
        
        const mensajes = [
            { t: "Iniciando procesador...", p: 20 },
            { t: currentTarget === 'excel' ? "Generando Excel..." : "Generando Word...", p: 50 },
            { t: "Validando plantillas...", p: 80 },
            { t: "Gracias por usar el generador", p: 100 }
        ];

        for (const m of mensajes) {
            status.innerText = m.t;
            bar.style.width = m.p + "%";
            await new Promise(r => setTimeout(r, 600));
        }

        if (currentTarget === 'acta') await descargarWord('MODELO_DOS.docx', 'RECEPCION');
        if (currentTarget === 'tabla') await descargarWord('MODELO_WORD_TABLA.docx', 'TABLA');
        if (currentTarget === 'excel') await descargarExcel();

        setTimeout(() => { overlay.style.display = 'none'; bar.style.width = "0%"; }, 500);
    }

    function obtenerDataFinal() {
        const n = document.querySelectorAll('.detenido_nombre');
        const d = document.querySelectorAll('.detenido_dni');
        const e = document.querySelectorAll('.detenido_edad');
        let lista = [];
        n.forEach((input, i) => {
            if(input.value.trim()) {
                lista.push({ num: i+1, nombre: input.value.toUpperCase(), dni: d[i].value || "---", edad: e[i].value || "---" });
            }
        });

        const an = document.querySelectorAll('.agraviado_nombre');
        const ad = document.querySelectorAll('.agraviado_dni');
        const ae = document.querySelectorAll('.agraviado_edad');
        let lista_agraviados = [];
        an.forEach((input, i) => {
            if(input.value.trim()) {
                lista_agraviados.push({ 
                    num: i+1, 
                    nombre_agraviado: input.value.toUpperCase(), 
                    dni_agraviado: ad[i].value || "---", 
                    edad_agraviado: ae[i].value || "---" 
                });
            }
        });

        const fiscalFinal = document.getElementById('fiscal_responsable').value === "OTROS" ? document.getElementById('fiscal_otros').value : document.getElementById('fiscal_responsable').value;

        return {
            HORA: document.getElementById('hora_acta').value,
            FECHA: document.getElementById('fecha_acta').value,
            NUMERO_FISCALIA: document.getElementById('num_fiscalia').value,
            FISCAL_RESPONSABLE: fiscalFinal.toUpperCase(),
            NOMBRE_PNP: document.getElementById('nombre_pnp').value.toUpperCase(),
            DNI_PNP: document.getElementById('dni_pnp').value,
            CELULAR_PNP: document.getElementById('celular_pnp').value,
            UNIDAD_PNP: document.getElementById('unidad_pnp').value === "OTROS" ? document.getElementById('unidad_pnp_otros').value.toUpperCase() : document.getElementById('unidad_pnp').value,
            DELITO: document.getElementById('delito').value.toUpperCase(),
            LUGAR_INTERVENCION: document.getElementById('lugar_intervencion').value.toUpperCase(),
            lista_detenidos: lista,
            lista_agraviados: lista_agraviados,
            NOMBRE_AGRAVIADO: lista_agraviados.length > 0 ? lista_agraviados[0].nombre_agraviado : "---",
            HORA_INTERVENCION: document.getElementById('hora_intervencion').value,
            es_arresto_ciudadano: document.getElementById('check_arresto').checked,
            NOMBRE_CIUDADANO: document.getElementById('nombre_ciudadano').value.toUpperCase(),
            DNI_CIUDADANO: document.getElementById('dni_ciudadano').value,
            TIPO_FLAGRANCIA: document.getElementById('tipo_flagrancia').value,
            HORA_CIERRE: document.getElementById('hora_cierre').value
        };
    }

    async function descargarWord(plantilla, prefijo) {
        const data = obtenerDataFinal();
        try {
            const resp = await fetch(plantilla);
            const content = await resp.arrayBuffer();
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            doc.render(data);
            const out = doc.getZip().generate({ type: "blob" });
            saveAs(out, `${prefijo}_${data.lista_detenidos[0]?.nombre || 'DOC'}.docx`);
        } catch (e) { alert("Error con la plantilla Word."); }
    }

    async function descargarExcel() {
        const data = obtenerDataFinal();
        const nombreArchivoModelo = "EXCEL_UNO.xlsx"; 

        if (data.lista_detenidos.length === 0) {
            alert("No hay detenidos para agregar.");
            return;
        }

        try {
            const respuesta = await fetch(nombreArchivoModelo);
            if (!respuesta.ok) throw new Error();
            const arrayBuffer = await respuesta.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const nombreHoja = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[nombreHoja];

            let contenidoExistente = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const encabezado = contenidoExistente.slice(0, 1);
            const datosHistoricos = contenidoExistente.slice(1);

            const nuevasFilas = data.lista_detenidos.map(det => {
                const fiscalLimpio = data.FISCAL_RESPONSABLE.replace(/DR\.|DRA\./g, "").trim().toUpperCase();
                return [
                    fiscalLimpio,
                    data.FECHA,
                    data.HORA_INTERVENCION,
                    data.LUGAR_INTERVENCION,
                    data.UNIDAD_PNP,
                    data.NOMBRE_PNP,
                    data.DNI_PNP,
                    det.nombre.toUpperCase(),
                    det.dni,
                    det.edad,
                    data.lista_detenidos.length,
                    data.DELITO.toUpperCase(),
                    "", "", "", "",
                    data.NOMBRE_AGRAVIADO.toUpperCase()
                ];
            });

            const resultadoFinal = encabezado.concat(nuevasFilas, datosHistoricos);
            const nuevaWs = XLSX.utils.aoa_to_sheet(resultadoFinal);
            workbook.Sheets[nombreHoja] = nuevaWs;

            const hoy = new Date();
            XLSX.writeFile(workbook, `TURNO_ACTUALIZADO_${hoy.getDate()}_${hoy.getMonth() + 1}.xlsx`);

        } catch (error) {
            alert("Error: Aseg√∫rate de que 'EXCEL_UNO.xlsx' est√© en la misma carpeta.");
        }
    }

    async function enviarAGoogleSheets() {
        const data = obtenerDataFinal();
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzOzTUSOfafoweMEff_aisETfBA4so51SbmtQpZfPsYo2HJn09vkt02Uo2VHpPOO4VM/exec";

        if (data.lista_detenidos.length === 0) {
            alert("‚ö†Ô∏è No hay detenidos para registrar.");
            return;
        }

        const overlay = document.getElementById('loader-overlay');
        const status = document.getElementById('loader-status');
        const bar = document.getElementById('progress-bar');
        const link = document.getElementById('link-verificacion');
        
        link.style.display = 'none';
        overlay.style.display = 'flex';
        status.innerText = "CONECTANDO CON LA NUBE...";
        bar.style.width = "30%";

        try {
            await fetch(URL_SCRIPT, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            bar.style.width = "100%";
            status.innerHTML = "‚úÖ ¬°INFORMACI√ìN SUBIDA EXITOSAMENTE!";
            link.style.display = 'block';
            
            setTimeout(() => {
                overlay.style.display = 'none';
                bar.style.width = "0%";
                link.style.display = 'none';
            }, 6000);

        } catch (error) {
            overlay.style.display = 'none';
            alert("‚ùå Error al subir a Google Sheets.");
        }
    }
</script>
</body>
</html>
