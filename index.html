<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acta de Recepci√≥n - PROYECTO OMAR</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.5/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --primary: #2563eb;
            --success: #059669; --border: #e2e8f0; --label: #64748b; --accent: #dbeafe;
            --danger: #dc2626;
        }

        body.dark-mode {
            --bg: #020617; --card: #1e293b; --text: #f8fafc; --primary: #60a5fa;
            --success: #10b981; --border: #334155; --label: #94a3b8; --accent: #1e293b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .app-container { width: 100%; max-width: 900px; background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); margin: 20px 0; }
        
        .header { text-align: center; margin-bottom: 35px; }
        h1 { font-size: 1.8rem; color: var(--primary); margin: 0; letter-spacing: -0.5px; line-height: 1.2; }
        .subtitle { font-size: 0.9rem; color: var(--danger); font-weight: 800; margin-top: 10px; padding: 8px; border: 1px dashed var(--danger); border-radius: 8px; display: inline-block; background: rgba(220, 38, 38, 0.05); }

        .theme-toggle { align-self: flex-end; background: var(--card); border: 2px solid var(--border); padding: 10px 20px; border-radius: 50px; cursor: pointer; color: var(--text); font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }

        .section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 30px 0 15px 0; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--label); margin-bottom: 6px; text-transform: uppercase; margin-left: 5px; }
        
        input, select { width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--accent); }

        .detenido-card { background: var(--accent); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); position: relative;}
        .btn-add { background: transparent; color: var(--primary); border: 2px dashed var(--primary); padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-add:hover { background: var(--accent); }
        .btn-remove { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; border-radius: 6px; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; font-weight: bold;}

        .option-card { background: var(--bg); border: 2px solid var(--border); padding: 20px; border-radius: 15px; margin: 25px 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .option-card.active { border-color: var(--success); background: rgba(5, 150, 105, 0.05); }
        .option-text { display: flex; flex-direction: column; }
        .option-title { font-weight: 700; font-size: 1.1rem; }
        .option-desc { font-size: 0.85rem; color: var(--label); margin-top: 4px; }

        .switch { position: relative; width: 50px; height: 26px; background: var(--border); border-radius: 20px; }
        .switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.3s; }
        input:checked + .option-card .switch { background: var(--success); }
        input:checked + .option-card .switch::after { transform: translateX(24px); }

        .btn-main { width: 100%; background: var(--primary); color: white; padding: 18px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 30px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; max-width: 600px; padding: 30px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .resumen-list { margin: 20px 0; max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        .resumen-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 15px; }
        .resumen-l { font-size: 0.8rem; font-weight: 700; color: var(--label); text-transform: uppercase; }
        .resumen-v { font-size: 0.95rem; font-weight: 600; text-align: right; }

        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-cancel { background: var(--label); color: white; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .btn-go { background: var(--success); color: white; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="document.body.classList.toggle('dark-mode')">
    üåì MODO OSCURO / CLARO
</button>

<div class="app-container">
    <div class="header">
        <h1>‚öñÔ∏è Acta de registro de recepci√≥n de comunicaci√≥n policial v√≠a telef√≥nica - PROYECTO OMAR</h1>
        <div class="subtitle">‚ö†Ô∏è USO PARA FINES INTERNOS - PROHIBIDA LA DIFUSI√ìN DE ESTE ENLACE SIN AUTORIZACI√ìN</div>
    </div>
    
    <form id="docForm">
        <div class="section-title">üèõÔ∏è 1. Datos del Acta y Fiscal√≠a</div>
        <div class="grid-3">
            <div class="field-group">
                <label>Hora de Llamada (Acta)</label>
                <input type="time" id="hora_acta">
            </div>
            <div class="field-group">
                <label>Fecha del Acta</label>
                <input type="text" id="fecha_acta" placeholder="Ej: 25 de febrero de 2026">
            </div>
            <div class="field-group">
                <label>N¬∞ Fiscal√≠a</label>
                <select id="num_fiscalia">
                    <option value="PRIMERA">PRIMERA</option>
                    <option value="SEGUNDA">SEGUNDA</option>
                    <option value="TERCERA">TERCERA</option>
                </select>
            </div>
        </div>
        <div class="field-group" style="margin-top: 15px;">
            <label>Fiscal Responsable (Receptor)</label>
            <input type="text" id="fiscal_responsable" placeholder="Ej: DRA. SARA RUTH YARLEQU√â ADRIANZE">
        </div>

        <div class="section-title">üëÆ 2. Datos de la Comunicaci√≥n Policial</div>
        <div class="grid-3">
            <div class="field-group">
                <label>Celular Origen</label>
                <input type="text" id="celular_pnp" placeholder="N√∫mero de quien llama">
            </div>
            <div class="field-group">
                <label>Nombre del PNP</label>
                <input type="text" id="nombre_pnp" placeholder="Grado y Nombre">
            </div>
            <div class="field-group">
                <label>DNI del PNP</label>
                <input type="text" id="dni_pnp" maxlength="8">
            </div>
        </div>
        <div class="grid" style="margin-top: 15px;">
            <div class="field-group">
                <label>Unidad Policial (Comisar√≠a/Dep.)</label>
                <select id="unidad_pnp" onchange="verificarUnidad()">
                    <option value="CEOPOL I MACREPOL PIURA">CEOPOL I MACREPOL PIURA</option>
                    <option value="COMISAR√çA PNP">COMISAR√çA PNP</option>
                    <option value="COMISAR√çA PNP DE EL INDIO">COMISAR√çA PNP DE EL INDIO</option>
                    <option value="COMISAR√çA PNP DE TACAL√Å">COMISAR√çA PNP DE TACAL√Å</option>
                    <option value="COMISAR√çA PNP DE VEINTIS√âIS DE OCTUBRE">COMISAR√çA PNP DE VEINTIS√âIS DE OCTUBRE</option>
                    <option value="COMISARIA LA ARENA">COMISARIA LA ARENA</option>
                    <option value="COMISARIA SULLANA">COMISARIA SULLANA</option>
                    <option value="CPNP 26 DE OCTUBRE">CPNP 26 DE OCTUBRE</option>
                    <option value="CPNP CASTILLA">CPNP CASTILLA</option>
                    <option value="CPNP CATACAOS">CPNP CATACAOS</option>
                    <option value="CPNP CHALACO">CPNP CHALACO</option>
                    <option value="CPNP CRUZETA">CPNP CRUZETA</option>
                    <option value="CPNP EL ALTO">CPNP EL ALTO</option>
                    <option value="CPNP EL INDIO">CPNP EL INDIO</option>
                    <option value="CPNP LA HUACA">CPNP LA HUACA</option>
                    <option value="CPNP LA UNI√ìN">CPNP LA UNI√ìN</option>
                    <option value="CPNP LOS ALGARROBOS">CPNP LOS ALGARROBOS</option>
                    <option value="CPNP MANCORA">CPNP MANCORA</option>
                    <option value="CPNP PAITA">CPNP PAITA</option>
                    <option value="CPNP PIURA" selected>CPNP PIURA</option>
                    <option value="CPNP PUEBLO NUEVO DE COLAN">CPNP PUEBLO NUEVO DE COLAN</option>
                    <option value="CPNP SAN MARTIN">CPNP SAN MARTIN</option>
                    <option value="CPNP TACAL√Å">CPNP TACAL√Å</option>
                    <option value="CPNP TALANDRACAS">CPNP TALANDRACAS</option>
                    <option value="CPNP TALARA">CPNP TALARA</option>
                    <option value="CPNP TAMARINDO">CPNP TAMARINDO</option>
                    <option value="CPNP TAMBOGRANDE">CPNP TAMBOGRANDE</option>
                    <option value="DEP. ROBO DE VEH√çCULOS PNP">DEP. ROBO DE VEH√çCULOS PNP</option>
                    <option value="DEPROVE PIURA">DEPROVE PIURA</option>
                    <option value="DIRECCI√ìN DESCONCENTRADA INDECI">DIRECCI√ìN DESCONCENTRADA INDECI</option>
                    <option value="EMERGENCIA PNP">EMERGENCIA PNP</option>
                    <option value="ESCUADRON EMERGENCIA 105 SULLANA">ESCUADRON EMERGENCIA 105 SULLANA</option>
                    <option value="ESCUADRON VERDE SULLANA">ESCUADRON VERDE SULLANA</option>
                    <option value="INVESTIGACI√ìN CRIMINAL PNP">INVESTIGACI√ìN CRIMINAL PNP</option>
                    <option value="RADIO PATRULLA PNP">RADIO PATRULLA PNP</option>
                    <option value="REGPOL PIURA SEC.">REGPOL PIURA SEC.</option>
                    <option value="SERENAZGO">SERENAZGO</option>
                    <option value="SERENAZGO (SECOM)">SERENAZGO (SECOM)</option>
                    <option value="OTROS">‚ûï OTROS (ESPECIFICAR)...</option>
                </select>
                <input type="text" id="unidad_pnp_otros" style="display: none; margin-top: 8px;" placeholder="Escriba la unidad policial...">
            </div>
        </div>

        <div class="section-title">üë§ 3. Datos de los Detenidos</div>
        <div id="contenedor_detenidos">
            <div class="detenido-card grid">
                <div class="field-group">
                    <label>Nombre Detenido 1</label>
                    <input type="text" class="detenido_nombre" placeholder="Nombres y apellidos completos">
                </div>
                <div class="field-group">
                    <label>DNI / Documento</label>
                    <input type="text" class="detenido_dni" placeholder="N¬∞ de Documento">
                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="agregarDetenido()">‚ûï AGREGAR OTRO DETENIDO</button>

        <div class="section-title">üö® 4. Detalles de la Intervenci√≥n</div>
        <div class="grid-3">
            <div class="field-group">
                <label>Hora de Intervenci√≥n</label>
                <input type="time" id="hora_intervencion">
            </div>
            <div class="field-group">
                <label>Delito Atribuido</label>
                <input type="text" id="delito" placeholder="Ej: ROBO AGRAVADO">
            </div>
            <div class="field-group">
                <label>Nombre del Agraviado</label>
                <input type="text" id="nombre_agraviado" placeholder="Nombre de la v√≠ctima">
            </div>
        </div>
        <div class="field-group" style="margin-top: 15px;">
            <label>Lugar de Intervenci√≥n</label>
            <input type="text" id="lugar_intervencion" placeholder="Direcci√≥n o referencia exacta">
        </div>

        <input type="checkbox" id="check_arresto" hidden onchange="toggleArresto()">
        <label for="check_arresto" class="option-card" id="arresto_card">
            <div class="option-text">
                <span class="option-title">ü§ù ¬øFue Arresto Ciudadano?</span>
                <span class="option-desc">Active esta opci√≥n si un civil realiz√≥ la retenci√≥n inicial.</span>
            </div>
            <div class="switch"></div>
        </label>

        <div id="campos_arresto" style="display: none; background: var(--accent); padding: 20px; border-radius: 15px; margin-top: -15px; border: 1px solid var(--border);">
            <div class="grid">
                <div class="field-group">
                    <label>Nombre del Ciudadano que arrest√≥</label>
                    <input type="text" id="nombre_ciudadano" placeholder="Nombres del civil">
                </div>
                <div class="field-group">
                    <label>DNI Ciudadano</label>
                    <input type="text" id="dni_ciudadano" maxlength="8">
                </div>
            </div>
            <div class="field-group" style="margin-top: 15px;">
                <label>Supuesto de Flagrancia Indicado</label>
                <select id="tipo_flagrancia">
                    <option value="PROPIAMENTE DICHA (Flagrancia estricta)">Propiamente dicha (Flagrancia estricta)</option>
                    <option value="CUASI FLAGRANCIA">Cuasi Flagrancia</option>
                </select>
            </div>
        </div>

        <div class="section-title">üèÅ 5. Cierre del Acta</div>
        <div class="field-group">
            <label>Hora de Cierre / Suscripci√≥n</label>
            <input type="time" id="hora_cierre">
        </div>

        <button type="button" class="btn-main" onclick="abrirResumen()">üîç VISTA PREVIA Y GENERAR WORD</button>
    </form>
</div>

<div id="modalResumen" class="modal">
    <div class="modal-content">
        <h2 style="margin:0; color: var(--primary)">VISTA PREVIA DE DATOS</h2>
        <p style="color: var(--label); margin-bottom: 15px; font-size: 0.9rem;">Verifique antes de generar el archivo WORD.</p>
        
        <div class="resumen-list" id="listaResumen"></div>

        <div class="modal-btns">
            <button class="btn-cancel" onclick="cerrarResumen()">VOLVER</button>
            <button class="btn-go" onclick="procesarWord()">DESCARGAR WORD</button>
        </div>
    </div>
</div>

<script>
    // Inicializar fecha actual
    window.onload = function() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const f = new Date();
        document.getElementById('fecha_acta').value = `${f.getDate()} de ${meses[f.getMonth()]} del ${f.getFullYear()}`;
    };

    // Mostrar/Ocultar "Otros" en Unidad Policial
    function verificarUnidad() {
        const select = document.getElementById('unidad_pnp');
        const inputOtros = document.getElementById('unidad_pnp_otros');
        if (select.value === "OTROS") {
            inputOtros.style.display = "block";
        } else {
            inputOtros.style.display = "none";
        }
    }

    // L√≥gica para agregar/quitar detenidos
    let contadorDetenidos = 1;
    function agregarDetenido() {
        contadorDetenidos++;
        const contenedor = document.getElementById('contenedor_detenidos');
        const idActual = contadorDetenidos;
        
        const div = document.createElement('div');
        div.className = 'detenido-card grid';
        div.id = `detenido_bloque_${idActual}`;
        div.innerHTML = `
            <button type="button" class="btn-remove" onclick="quitarDetenido(${idActual})">X QUITAR</button>
            <div class="field-group">
                <label>Nombre Detenido ${idActual}</label>
                <input type="text" class="detenido_nombre" placeholder="Nombres y apellidos completos">
            </div>
            <div class="field-group">
                <label>DNI / Documento</label>
                <input type="text" class="detenido_dni" placeholder="N¬∞ de Documento">
            </div>
        `;
        contenedor.appendChild(div);
    }

    function quitarDetenido(id) {
        document.getElementById(`detenido_bloque_${id}`).remove();
    }

    // L√≥gica Arresto Ciudadano
    function toggleArresto() {
        const isChecked = document.getElementById('check_arresto').checked;
        const campos = document.getElementById('campos_arresto');
        const card = document.getElementById('arresto_card');
        
        if(isChecked) {
            campos.style.display = 'block';
            card.classList.add('active');
        } else {
            campos.style.display = 'none';
            card.classList.remove('active');
        }
    }

    // Obtener Unidad Policial final
    function getUnidadPolicial() {
        const sel = document.getElementById('unidad_pnp').value;
        if (sel === "OTROS") {
            return document.getElementById('unidad_pnp_otros').value.toUpperCase();
        }
        return sel;
    }

    // Modal Resumen
    function abrirResumen() {
        const inputsNombres = document.querySelectorAll('.detenido_nombre');
        if(!inputsNombres[0].value) return alert("Ingrese al menos el nombre del primer detenido.");
        
        const cantDetenidos = document.querySelectorAll('.detenido_nombre').length;
        const unidadFinal = getUnidadPolicial();
        const esArresto = document.getElementById('check_arresto').checked;

        const res = [
            { l: "1er Detenido", v: inputsNombres[0].value.toUpperCase() },
            { l: "Total Detenidos", v: cantDetenidos },
            { l: "Delito", v: document.getElementById('delito').value.toUpperCase() },
            { l: "Unidad PNP", v: unidadFinal },
            { l: "Fiscal√≠a", v: document.getElementById('num_fiscalia').value },
            { l: "Arresto Ciudadano", v: esArresto ? "S√ç" : "NO" }
        ];

        document.getElementById('listaResumen').innerHTML = res.map(i => `
            <div class="resumen-row">
                <span class="resumen-l">${i.l}</span>
                <span class="resumen-v">${i.v}</span>
            </div>
        `).join('');
        
        document.getElementById('modalResumen').style.display = 'flex';
    }

    function cerrarResumen() { 
        document.getElementById('modalResumen').style.display = 'none'; 
    }

    // Generar Documento Word
    async function procesarWord() {
        cerrarResumen();

        // 1. Recopilar Lista de Detenidos
        const inputsNombres = document.querySelectorAll('.detenido_nombre');
        const inputsDnis = document.querySelectorAll('.detenido_dni');
        let listaParaWord = [];
        
        inputsNombres.forEach((input, index) => {
            if (input.value.trim() !== "") {
                listaParaWord.push({
                    num: index + 1,
                    nombre: input.value.toUpperCase().trim(),
                    dni: inputsDnis[index].value.trim() || "---"
                });
            }
        });

        // Nombre del archivo basado en el primer detenido
        let primerDetenidoStr = listaParaWord[0] ? listaParaWord[0].nombre.replace(/\s+/g, '_') : "SIN_NOMBRE";
        const nombreArchivoFinal = `RECEPCION_${primerDetenidoStr}.docx`;

        // 2. Construir Data Object
        const data = {
            HORA: document.getElementById('hora_acta').value,
            FECHA: document.getElementById('fecha_acta').value,
            NUMERO_FISCALIA: document.getElementById('num_fiscalia').value,
            FISCAL_RESPONSABLE: document.getElementById('fiscal_responsable').value.toUpperCase(),
            
            CELULAR_PNP: document.getElementById('celular_pnp').value,
            NOMBRE_PNP: document.getElementById('nombre_pnp').value.toUpperCase(),
            DNI_PNP: document.getElementById('dni_pnp').value,
            UNIDAD_PNP: getUnidadPolicial(),
            
            lista_detenidos: listaParaWord,
            
            HORA_INTERVENCION: document.getElementById('hora_intervencion').value,
            LUGAR_INTERVENCION: document.getElementById('lugar_intervencion').value.toUpperCase(),
            DELITO: document.getElementById('delito').value.toUpperCase(),
            NOMBRE_AGRAVIADO: document.getElementById('nombre_agraviado').value.toUpperCase(),
            
            es_arresto_ciudadano: document.getElementById('check_arresto').checked,
            NOMBRE_CIUDADANO: document.getElementById('nombre_ciudadano').value.toUpperCase(),
            DNI_CIUDADANO: document.getElementById('dni_ciudadano').value,
            TIPO_FLAGRANCIA: document.getElementById('tipo_flagrancia').value,
            
            HORA_CIERRE: document.getElementById('hora_cierre').value
        };

        // 3. Procesar archivo MODELO_UNO.docx
        try {
            const resp = await fetch('MODELO_UNO.docx');
            if(!resp.ok) throw new Error("No se encontr√≥ MODELO_UNO.docx");
            
            const content = await resp.arrayBuffer();
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            
            doc.render(data);
            
            const out = doc.getZip().generate({ 
                type: "blob", 
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document", 
                compression: "DEFLATE" 
            });
            
            saveAs(out, nombreArchivoFinal);

        } catch (error) {
            console.error(error);
            alert("‚ùå Error: Aseg√∫rate de que el archivo MODELO_UNO.docx est√© en la misma carpeta/repositorio y se llame exactamente as√≠.");
        }
    }
</script>

</body>
</html>
