<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema PROYECTO OMAR - Fiscalia</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.5/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #020617; --card: #1e293b; --text: #f8fafc; --primary: #60a5fa;
            --success: #10b981; --border: #334155; --label: #94a3b8; --accent: #1e293b;
            --danger: #ef4444; --excel: #16a34a; --word: #2563eb;
        }

        body.light-mode {
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --primary: #2563eb;
            --success: #059669; --border: #e2e8f0; --label: #64748b; --accent: #dbeafe;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .app-container { width: 100%; max-width: 900px; background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: 20px 0; border: 1px solid var(--border); }
        
        .header { text-align: center; margin-bottom: 35px; }
        h1 { font-size: 1.8rem; color: var(--primary); margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { font-size: 0.8rem; color: var(--danger); font-weight: 800; margin-top: 10px; padding: 8px 15px; border: 1px solid var(--danger); border-radius: 6px; display: inline-block; text-transform: uppercase; }

        .section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 30px 0 15px 0; border-bottom: 2px solid var(--border); padding-bottom: 5px; }

        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .field-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        label { font-size: 0.7rem; font-weight: 700; color: var(--label); margin-bottom: 5px; text-transform: uppercase; }
        
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: #0f172a; color: white; font-size: 0.95rem; }
        body.light-mode input, body.light-mode select { background: #fff; color: #000; }

        .detenido-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); position: relative; }
        .btn-add { background: transparent; color: var(--primary); border: 2px dashed var(--primary); padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: 800; }

        /* Botones de Acci√≥n Especiales */
        .download-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 40px; }
        .btn-download { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; border-radius: 20px; border: none; cursor: pointer; color: white; font-weight: 800; gap: 10px; text-transform: uppercase; }
        .btn-word { background: var(--word); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); }
        .btn-excel { background: var(--excel); box-shadow: 0 10px 20px rgba(22, 163, 74, 0.3); }
        .btn-download:hover { transform: translateY(-5px); filter: brightness(1.1); }
        .btn-download span { font-size: 0.75rem; opacity: 0.9; }

        /* Barra de Carga / Overlay */
        #loader-overlay { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .loader-box { width: 300px; text-align: center; }
        .loader-text { margin-bottom: 15px; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .progress-container { width: 100%; height: 8px; background: #334155; border-radius: 10px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; box-shadow: 0 0 15px var(--primary); }

        .btn-remove { position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
    </style>
</head>
<body class="dark-mode">

<div id="loader-overlay">
    <div class="loader-box">
        <div class="loader-text" id="loader-status">GENERANDO...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="header">
        <h1>‚öñÔ∏è PROYECTO OMAR</h1>
        <div class="subtitle">Generador de Documentaci√≥n Fiscal</div>
    </div>
    
    <form id="docForm">
        <div class="section-title">üèõÔ∏è 1. Datos del Acta</div>
        <div class="grid-3">
            <div class="field-group"><label>Hora Llamada</label><input type="time" id="hora_acta"></div>
            <div class="field-group"><label>Fecha</label><input type="text" id="fecha_acta"></div>
            <div class="field-group">
                <label>Fiscal√≠a</label>
                <select id="num_fiscalia">
                    <option value="PRIMERA">PRIMERA</option>
                    <option value="SEGUNDA" selected>SEGUNDA</option>
                    <option value="TERCERA">TERCERA</option>
                </select>
            </div>
        </div>
        <div class="field-group"><label>Fiscal Responsable</label><input type="text" id="fiscal_responsable" value="DRA. SARA RUTH YARLEQU√â ADRIANZE"></div>

        <div class="section-title">üëÆ 2. Datos PNP</div>
        <div class="grid-3">
            <div class="field-group"><label>Nombre PNP</label><input type="text" id="nombre_pnp"></div>
            <div class="field-group"><label>DNI PNP</label><input type="text" id="dni_pnp" maxlength="8"></div>
            <div class="field-group"><label>Celular</label><input type="text" id="celular_pnp"></div>
        </div>

        <div class="section-title">üë§ 3. Datos Detenidos</div>
        <div id="contenedor_detenidos">
            <div class="detenido-card">
                <div class="grid-3">
                    <div class="field-group"><label>Nombre</label><input type="text" class="detenido_nombre"></div>
                    <div class="field-group"><label>DNI</label><input type="text" class="detenido_dni"></div>
                    <div class="field-group"><label>Edad</label><input type="number" class="detenido_edad"></div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="agregarDetenido()">+ AGREGAR DETENIDO</button>

        <div class="section-title">üö® 4. Delito y Lugar</div>
        <div class="grid-3">
            <div class="field-group"><label>Delito</label><input type="text" id="delito"></div>
            <div class="field-group"><label>Hora Int.</label><input type="time" id="hora_intervencion"></div>
            <div class="field-group"><label>Lugar</label><input type="text" id="lugar_intervencion"></div>
        </div>

        <div class="download-options">
            <button type="button" class="btn-download btn-word" onclick="ejecutarDescarga('word')">
                üìÑ GENERAR WORD
                <span>MODELO_DOS + TABLA</span>
            </button>
            <button type="button" class="btn-download btn-excel" onclick="ejecutarDescarga('excel')">
                üìä GENERAR EXCEL
                <span>LISTADO DE DETENIDOS</span>
            </button>
        </div>
    </form>
</div>

<script>
    window.onload = function() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const f = new Date();
        document.getElementById('fecha_acta').value = `${f.getDate()} de ${meses[f.getMonth()]} del ${f.getFullYear()}`;
    };

    function agregarDetenido() {
        const contenedor = document.getElementById('contenedor_detenidos');
        const id = Date.now();
        const div = document.createElement('div');
        div.className = 'detenido-card';
        div.id = `bloque_${id}`;
        div.innerHTML = `
            <button type="button" class="btn-remove" onclick="document.getElementById('bloque_${id}').remove()">‚úï</button>
            <div class="grid-3">
                <div class="field-group"><label>Nombre</label><input type="text" class="detenido_nombre"></div>
                <div class="field-group"><label>DNI</label><input type="text" class="detenido_dni"></div>
                <div class="field-group"><label>Edad</label><input type="number" class="detenido_edad"></div>
            </div>`;
        contenedor.appendChild(div);
    }

    // L√≥gica de Animaci√≥n y Control
    async function ejecutarDescarga(tipo) {
        const nombres = document.querySelectorAll('.detenido_nombre');
        if(!nombres[0].value) return alert("Ingrese al menos un detenido");

        mostrarLoader(tipo);

        // Simulaci√≥n de carga decorativa
        await moverBarra(30);
        
        const data = recopilarDatos();

        if(tipo === 'word') {
            await moverBarra(60);
            await generarWord('MODELO_DOS.docx', data, `ACTA_${data.lista_detenidos[0].nombre}.docx`);
            await moverBarra(90);
            await generarWord('MODELO_TABLA.docx', data, `TABLA_${data.lista_detenidos[0].nombre}.docx`);
        } else {
            await moverBarra(70);
            generarExcel(data);
        }

        await moverBarra(100);
        setTimeout(ocultarLoader, 500);
    }

    function recopilarDatos() {
        const n = document.querySelectorAll('.detenido_nombre');
        const d = document.querySelectorAll('.detenido_dni');
        const e = document.querySelectorAll('.detenido_edad');
        let lista = [];
        n.forEach((input, i) => {
            if(input.value.trim()) {
                lista.push({ 
                    num: i+1, 
                    nombre: input.value.toUpperCase(), 
                    dni: d[i].value || "---", 
                    edad: e[i].value || "---" 
                });
            }
        });

        return {
            HORA: document.getElementById('hora_acta').value,
            FECHA: document.getElementById('fecha_acta').value,
            NUMERO_FISCALIA: document.getElementById('num_fiscalia').value,
            FISCAL_RESPONSABLE: document.getElementById('fiscal_responsable').value.toUpperCase(),
            NOMBRE_PNP: document.getElementById('nombre_pnp').value.toUpperCase(),
            DNI_PNP: document.getElementById('dni_pnp').value,
            CELULAR_PNP: document.getElementById('celular_pnp').value,
            DELITO: document.getElementById('delito').value.toUpperCase(),
            LUGAR_INTERVENCION: document.getElementById('lugar_intervencion').value.toUpperCase(),
            lista_detenidos: lista
        };
    }

    async function generarWord(plantilla, data, nombreSalida) {
        try {
            const resp = await fetch(plantilla);
            const content = await resp.arrayBuffer();
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            doc.render(data);
            const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            saveAs(out, nombreSalida);
        } catch (err) {
            console.error(err);
        }
    }

    function generarExcel(data) {
        const ws = XLSX.utils.json_to_sheet(data.lista_detenidos);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Detenidos");
        XLSX.writeFile(wb, `DETENIDOS_OMAR_${data.lista_detenidos[0].nombre}.xlsx`);
    }

    // Funciones Visuales
    function mostrarLoader(tipo) {
        const overlay = document.getElementById('loader-overlay');
        const status = document.getElementById('loader-status');
        const bar = document.getElementById('progress-bar');
        bar.style.width = "0%";
        status.innerText = tipo === 'word' ? "GENERANDO DOCUMENTOS WORD..." : "GENERANDO REPORTE EXCEL...";
        overlay.style.display = 'flex';
    }

    function ocultarLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
    }

    function moverBarra(porcentaje) {
        return new Promise(resolve => {
            document.getElementById('progress-bar').style.width = porcentaje + "%";
            setTimeout(resolve, 400);
        });
    }
</script>

</body>
</html>
